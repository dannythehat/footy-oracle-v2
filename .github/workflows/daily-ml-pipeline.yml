name: ðŸš€ Daily ML Pipeline - Golden Betopia

on:
  schedule:
    - cron: '0 6 * * *'  # 6 AM UTC = 8 AM Sofia time (Bulgaria)
  workflow_dispatch:      # Manual trigger

jobs:
  generate-predictions:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout footy-oracle-v2
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          path: footy-oracle-v2
      
      - name: ðŸ“¥ Checkout football-betting-ai-system
        uses: actions/checkout@v4
        with:
          repository: dannythehat/football-betting-ai-system
          token: ${{ secrets.PAT_TOKEN }}
          path: football-betting-ai-system
      
      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          cd football-betting-ai-system
          pip install pandas numpy scikit-learn joblib requests
      
      - name: ðŸ¤– Run Daily Predictions (Real ML Models)
        run: |
          cd football-betting-ai-system
          python footy_oracle_v2/scripts/run_daily_predictions.py
          
          echo "ðŸ“Š Prediction Summary:"
          if [ -f "shared/ml_outputs/golden_bets.json" ]; then
            echo "âœ… Golden Bets generated"
          fi
          if [ -f "shared/ml_outputs/value_bets.json" ]; then
            echo "âœ… Value Bets generated"
          fi
          if [ -f "shared/ml_outputs/predictions.json" ]; then
            echo "âœ… Predictions generated"
          fi
      
      - name: ðŸ“¤ Copy outputs to footy-oracle-v2
        run: |
          # Create shared/ml_outputs directory
          mkdir -p footy-oracle-v2/shared/ml_outputs
          
          # Copy prediction files from football-betting-ai-system to footy-oracle-v2
          cp football-betting-ai-system/shared/ml_outputs/*.json footy-oracle-v2/shared/ml_outputs/ || true
          
          # Add timestamp
          echo "{\"generated_at\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\", \"version\": \"v27\", \"timezone\": \"Sofia/Bulgaria (UTC+2)\"}" > footy-oracle-v2/shared/ml_outputs/metadata.json
          
          echo "âœ… Outputs copied to footy-oracle-v2/shared/ml_outputs/"
          ls -lh footy-oracle-v2/shared/ml_outputs/
      
      - name: ðŸ’¾ Commit and push to footy-oracle-v2
        run: |
          cd footy-oracle-v2
          git config user.name "Golden Betopia Bot"
          git config user.email "bot@golden-betopia.com"
          
          git add shared/ml_outputs/*
          
          if git diff --staged --quiet; then
            echo "ðŸ“­ No changes to commit"
          else
            git commit -m "ðŸ¤– Daily ML predictions - $(date +%Y-%m-%d) 8AM Sofia time"
            git push
            echo "âœ… Predictions pushed to repository"
          fi
      
      - name: ðŸ“Š Pipeline Summary
        if: always()
        run: |
          echo "## ðŸš€ ML Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** 8:00 AM Sofia, Bulgaria ($(date +%H:%M:%S) UTC)" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v27" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "football-betting-ai-system/shared/ml_outputs/predictions.json" ]; then
            echo "âœ… **Predictions:** Generated successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Predictions:** Failed to generate" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "football-betting-ai-system/shared/ml_outputs/golden_bets.json" ]; then
            echo "âœ… **Golden Bets:** Generated successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Golden Bets:** Failed to generate" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "football-betting-ai-system/shared/ml_outputs/value_bets.json" ]; then
            echo "âœ… **Value Bets:** Generated successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Value Bets:** Failed to generate" >> $GITHUB_STEP_SUMMARY
          fi
