name: ğŸš€ Daily ML Pipeline - Golden Betopia

on:
  schedule:
    - cron: '0 6 * * *'  # 6 AM UTC = 8 AM Sofia time (Bulgaria)
  workflow_dispatch:      # Manual trigger

jobs:
  generate-predictions:
    runs-on: self-hosted  # Run on your local Windows machine
    
    steps:
      - name: ğŸ“¥ Checkout footy-oracle-v2
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          path: footy-oracle-v2-repo
      
      - name: ğŸ¤– Run Daily ML Predictions (Local Machine)
        shell: powershell
        run: |
          Write-Host "ğŸš€ Starting ML predictions on local machine..."
          Write-Host "ğŸ“ Working directory: $(Get-Location)"
          
          # Navigate to your local ML system
          cd C:\Users\Danny\football-betting-ai-system\betopia_v2\scripts
          
          # Run the PowerShell script
          .\run_daily_v26.ps1
          
          Write-Host "âœ… ML predictions completed"
      
      - name: ğŸ“¤ Copy ML outputs to repo
        shell: powershell
        run: |
          Write-Host "ğŸ“¤ Copying ML outputs to GitHub repo..."
          
          # Source: Your local ML outputs
          $source = "C:\Users\Danny\Documents\GitHub\golden-footy_oracle\shared\ml_outputs\*"
          
          # Destination: Checked out repo
          $dest = "footy-oracle-v2-repo\shared\ml_outputs"
          
          # Create destination directory
          New-Item -ItemType Directory -Force -Path $dest | Out-Null
          
          # Copy all JSON files
          Copy-Item -Path $source -Destination $dest -Force
          
          Write-Host "âœ… Files copied:"
          Get-ChildItem $dest | Format-Table Name, Length, LastWriteTime
      
      - name: ğŸ’¾ Commit and push predictions
        shell: powershell
        run: |
          cd footy-oracle-v2-repo
          
          git config user.name "Golden Betopia Bot"
          git config user.email "bot@golden-betopia.com"
          
          git add shared/ml_outputs/*
          
          $changes = git diff --staged --quiet
          if ($LASTEXITCODE -ne 0) {
            $date = Get-Date -Format "yyyy-MM-dd HH:mm"
            git commit -m "ğŸ¤– Daily ML predictions - $date Sofia time"
            git push
            Write-Host "âœ… Predictions pushed to GitHub"
          } else {
            Write-Host "ğŸ“­ No changes to commit"
          }
      
      - name: ğŸ“Š Pipeline Summary
        if: always()
        shell: powershell
        run: |
          $summary = @"
          ## ğŸš€ ML Pipeline Summary
          
          **Date:** $(Get-Date -Format "yyyy-MM-dd")
          **Time:** $(Get-Date -Format "HH:mm:ss") Sofia, Bulgaria
          **Machine:** $env:COMPUTERNAME
          **Version:** v26
          
          ### Generated Files:
          "@
          
          $outputDir = "C:\Users\Danny\Documents\GitHub\golden-footy_oracle\shared\ml_outputs"
          
          if (Test-Path "$outputDir\predictions.json") {
            $summary += "`nâœ… **predictions.json** - Generated"
          } else {
            $summary += "`nâŒ **predictions.json** - Missing"
          }
          
          if (Test-Path "$outputDir\golden_bets.json") {
            $summary += "`nâœ… **golden_bets.json** - Generated"
          } else {
            $summary += "`nâŒ **golden_bets.json** - Missing"
          }
          
          if (Test-Path "$outputDir\value_bets.json") {
            $summary += "`nâœ… **value_bets.json** - Generated"
          } else {
            $summary += "`nâŒ **value_bets.json** - Missing"
          }
          
          $summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
