name: ðŸ“… Update Fixtures - Live Data

on:
  schedule:
    - cron: '0 */2 * * *'  # Every 2 hours
  workflow_dispatch:        # Manual trigger

jobs:
  update-fixtures:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
      
      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          pip install requests python-dotenv
      
      - name: ðŸ” Validate API Key Secret
        env:
          API_FOOTBALL_KEY: ${{ secrets.API_FOOTBALL_KEY }}
        run: |
          if [ -z "$API_FOOTBALL_KEY" ]; then
            echo "âŒ CRITICAL ERROR: API_FOOTBALL_KEY secret is NOT set in GitHub!"
            echo "Go to: Settings â†’ Secrets and variables â†’ Actions â†’ Repository secrets"
            echo "Add secret: API_FOOTBALL_KEY = 630aac264ef27676e498d4f4edc212e0"
            exit 1
          else
            echo "âœ… API_FOOTBALL_KEY secret exists (length: ${#API_FOOTBALL_KEY})"
            echo "First 8 chars: ${API_FOOTBALL_KEY:0:8}..."
          fi
      
      - name: ðŸ§ª Test API Connection
        env:
          API_FOOTBALL_KEY: ${{ secrets.API_FOOTBALL_KEY }}
        run: |
          python -c "
          import os
          import requests
          import json
          
          API_KEY = os.environ['API_FOOTBALL_KEY']
          
          print('ðŸ” Testing API connection...')
          print(f'API Key (first 8): {API_KEY[:8]}...')
          print(f'API Key length: {len(API_KEY)}')
          
          headers = {'x-apisports-key': API_KEY}
          url = 'https://v3.football.api-sports.io/status'
          
          print(f'\\nURL: {url}')
          print(f'Headers: {headers}')
          
          try:
              response = requests.get(url, headers=headers, timeout=10)
              print(f'\\nâœ… Status Code: {response.status_code}')
              print(f'Response Headers: {dict(response.headers)}')
              print(f'\\nResponse Body:')
              print(json.dumps(response.json(), indent=2))
              
              if response.status_code != 200:
                  print(f'\\nâŒ API ERROR!')
                  exit(1)
              else:
                  print(f'\\nâœ… API connection successful!')
          except Exception as e:
              print(f'\\nâŒ EXCEPTION: {str(e)}')
              import traceback
              traceback.print_exc()
              exit(1)
          "
      
      - name: ðŸ“Š Fetch today's fixtures
        env:
          API_FOOTBALL_KEY: ${{ secrets.API_FOOTBALL_KEY }}
        run: |
          python -c "
          import os
          import requests
          from datetime import datetime, timedelta
          import json
          
          API_KEY = os.environ['API_FOOTBALL_KEY']
          
          today = datetime.now().strftime('%Y-%m-%d')
          tomorrow = (datetime.now() + timedelta(days=1)).strftime('%Y-%m-%d')
          
          headers = {'x-apisports-key': API_KEY}
          
          all_fixtures = []
          
          # Fetch today's fixtures
          print(f'ðŸ“… Fetching fixtures for {today}...')
          url = f'https://v3.football.api-sports.io/fixtures?date={today}'
          response = requests.get(url, headers=headers)
          
          if response.status_code == 200:
              today_fixtures = response.json()['response']
              all_fixtures.extend(today_fixtures)
              print(f'âœ… Today: {len(today_fixtures)} fixtures')
          else:
              print(f'âŒ Error: {response.status_code}')
              print(f'Response: {response.text}')
          
          # Fetch tomorrow's fixtures
          print(f'ðŸ“… Fetching fixtures for {tomorrow}...')
          url = f'https://v3.football.api-sports.io/fixtures?date={tomorrow}'
          response = requests.get(url, headers=headers)
          
          if response.status_code == 200:
              tomorrow_fixtures = response.json()['response']
              all_fixtures.extend(tomorrow_fixtures)
              print(f'âœ… Tomorrow: {len(tomorrow_fixtures)} fixtures')
          else:
              print(f'âŒ Error: {response.status_code}')
              print(f'Response: {response.text}')
          
          # Save fixtures
          os.makedirs('shared/fixtures', exist_ok=True)
          with open('shared/fixtures/upcoming.json', 'w') as f:
              json.dump(all_fixtures, f, indent=2)
          
          # Save metadata
          metadata = {
              'updated_at': datetime.now().isoformat(),
              'total_fixtures': len(all_fixtures),
              'today_count': len([f for f in all_fixtures if f.get('fixture', {}).get('date', '').startswith(today)]),
              'tomorrow_count': len([f for f in all_fixtures if f.get('fixture', {}).get('date', '').startswith(tomorrow)])
          }
          
          with open('shared/fixtures/metadata.json', 'w') as f:
              json.dump(metadata, f, indent=2)
          
          print(f'\\nâœ… Total: {len(all_fixtures)} fixtures saved')
          
          if len(all_fixtures) == 0:
              print('âš ï¸  WARNING: No fixtures fetched')
          "
      
      - name: ðŸ“Š Fetch live matches
        env:
          API_FOOTBALL_KEY: ${{ secrets.API_FOOTBALL_KEY }}
        run: |
          python -c "
          import os
          import requests
          import json
          
          API_KEY = os.environ['API_FOOTBALL_KEY']
          headers = {'x-apisports-key': API_KEY}
          
          print('ðŸ”´ Fetching live matches...')
          url = 'https://v3.football.api-sports.io/fixtures?live=all'
          response = requests.get(url, headers=headers)
          
          if response.status_code == 200:
              live_matches = response.json()['response']
              print(f'âœ… Found {len(live_matches)} live matches')
              
              with open('shared/fixtures/live.json', 'w') as f:
                  json.dump(live_matches, f, indent=2)
          else:
              print(f'âš ï¸  API returned status {response.status_code}')
              print(f'Response: {response.text}')
              with open('shared/fixtures/live.json', 'w') as f:
                  json.dump([], f)
          "
      
      - name: ðŸ’¾ Commit and push updates
        run: |
          git config user.name "Fixtures Bot"
          git config user.email "fixtures@golden-betopia.com"
          
          git add shared/fixtures/*
          
          if git diff --staged --quiet; then
            echo "ðŸ“­ No fixture changes"
          else
            git commit -m "ðŸ“… Update fixtures - $(date +%Y-%m-%d\ %H:%M) UTC"
            git push
            echo "âœ… Fixtures updated"
          fi
      
      - name: ðŸ“Š Update Summary
        if: always()
        run: |
          echo "## ðŸ“… Fixtures Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date +%Y-%m-%d\ %H:%M:%S) UTC" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "shared/fixtures/metadata.json" ]; then
            echo "**Total Fixtures:** $(jq .total_fixtures shared/fixtures/metadata.json)" >> $GITHUB_STEP_SUMMARY
            echo "**Today:** $(jq .today_count shared/fixtures/metadata.json)" >> $GITHUB_STEP_SUMMARY
            echo "**Tomorrow:** $(jq .tomorrow_count shared/fixtures/metadata.json)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "shared/fixtures/live.json" ]; then
            echo "**Live Matches:** $(jq length shared/fixtures/live.json)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â° **Next Update:** In 2 hours" >> $GITHUB_STEP_SUMMARY
