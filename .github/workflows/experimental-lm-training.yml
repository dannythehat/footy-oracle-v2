name: ðŸ§ª Experimental LM Training Pipeline

on:
  schedule:
    - cron: '0 5 * * 0'  # 5 AM UTC every Sunday (weekly training)
  workflow_dispatch:      # Manual trigger

jobs:
  train-experimental-models:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          cd ml_training
          pip install -r requirements.txt
      
      - name: ðŸ” Check data availability
        id: check_data
        run: |
          python ml_training/scripts/02b_process_experimental_targets.py
        continue-on-error: true
      
      - name: ðŸ§ª Train experimental LM babies
        if: steps.check_data.outcome == 'success'
        run: |
          python ml_training/scripts/03b_train_experimental_models.py
      
      - name: ðŸ’¾ Commit experimental models
        if: steps.check_data.outcome == 'success'
        run: |
          git config user.name "Experimental LM Bot"
          git config user.email "experimental-lm-bot@footy-oracle.com"
          git add ml_training/models/experimental/*
          git add ml_training/data/processed/*
          git diff --staged --quiet || git commit -m "ðŸ§ª Weekly experimental LM training - $(date +%Y-%m-%d)"
          git push
      
      - name: ðŸ“Š Training Summary
        if: always()
        run: |
          echo "## ðŸ§ª Experimental LM Training Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f ml_training/models/experimental/experimental_metadata.json ]; then
            echo "### Experimental Model Performance" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat ml_training/models/experimental/experimental_metadata.json >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No experimental models trained (missing required data columns)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“š **Documentation:** [Experimental Models Guide](https://github.com/${{ github.repository }}/blob/main/ml_training/EXPERIMENTAL_MODELS.md)" >> $GITHUB_STEP_SUMMARY
