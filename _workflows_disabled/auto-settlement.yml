name: ðŸŽ¯ Auto-Settlement - Match Results

on:
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes
  workflow_dispatch:        # Manual trigger

jobs:
  settle-matches:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
      
      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          pip install requests python-dotenv
      
      - name: ðŸ” Check for finished matches
        id: check_matches
        env:
          API_FOOTBALL_KEY: ${{ secrets.API_FOOTBALL_KEY }}
          BACKEND_URL: ${{ secrets.BACKEND_URL }}
        run: |
          python -c "
          import os
          import requests
          import json
          from datetime import datetime, timedelta
          
          API_KEY = os.environ['API_FOOTBALL_KEY']
          BACKEND_URL = os.environ.get('BACKEND_URL', 'http://localhost:3001')
          
          headers = {'x-apisports-key': API_KEY}
          
          # Get matches from last 3 hours that might have finished
          now = datetime.now()
          start_time = (now - timedelta(hours=3)).strftime('%Y-%m-%d')
          
          print(f'ðŸ” Checking matches from {start_time}...')
          
          url = f'https://v3.football.api-sports.io/fixtures?date={start_time}&status=FT'
          response = requests.get(url, headers=headers)
          
          if response.status_code == 200:
              finished_matches = response.json()['response']
              print(f'âœ… Found {len(finished_matches)} finished matches')
              
              # Save for next step
              with open('finished_matches.json', 'w') as f:
                  json.dump(finished_matches, f)
              
              print(f'::set-output name=count::{len(finished_matches)}')
          else:
              print(f'âŒ API Error: {response.status_code}')
              print(f'::set-output name=count::0')
          "
      
      - name: ðŸŽ¯ Settle bets
        if: steps.check_matches.outputs.count > 0
        env:
          BACKEND_URL: ${{ secrets.BACKEND_URL }}
        run: |
          python -c "
          import json
          import requests
          import os
          
          BACKEND_URL = os.environ.get('BACKEND_URL', 'http://localhost:3001')
          
          # Load finished matches
          with open('finished_matches.json', 'r') as f:
              matches = json.load(f)
          
          settled_count = 0
          
          for match in matches:
              fixture_id = match['fixture']['id']
              home_score = match['goals']['home']
              away_score = match['goals']['away']
              
              try:
                  # Call backend settlement endpoint
                  response = requests.post(
                      f'{BACKEND_URL}/api/bets/settle',
                      json={
                          'fixtureId': fixture_id,
                          'homeScore': home_score,
                          'awayScore': away_score,
                          'status': 'FT'
                      }
                  )
                  
                  if response.status_code == 200:
                      settled_count += 1
                      print(f'âœ… Settled fixture {fixture_id}: {home_score}-{away_score}')
                  else:
                      print(f'âš ï¸  Failed to settle {fixture_id}: {response.status_code}')
              
              except Exception as e:
                  print(f'âŒ Error settling {fixture_id}: {e}')
          
          print(f'\\nðŸ“Š Settled {settled_count}/{len(matches)} matches')
          "
      
      - name: ðŸ“Š Settlement Summary
        if: always()
        run: |
          echo "## ðŸŽ¯ Settlement Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date +%H:%M:%S) UTC" >> $GITHUB_STEP_SUMMARY
          echo "**Matches Checked:** ${{ steps.check_matches.outputs.count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â° **Next Check:** In 5 minutes" >> $GITHUB_STEP_SUMMARY
